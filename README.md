# 贷款分期金融计算器

这是一个用于比较不同贷款分期方案的桌面应用程序，支持自动计算各种金融指标。

## 功能特性

### 表格列说明
应用程序包含8个列：
1. **名称/机构** - 贷款机构或产品名称
2. **借款/分期金额** - 贷款本金金额（必填）
3. **期数** - 分期还款期数（必填）
4. **平均每期利息** - 每期需要支付的利息
5. **总利息** - 整个贷款期间的总利息
6. **利息率** - 总利息占本金的百分比
7. **近似折算年化利率（单利）** - 根据持卡人现金流计算出内含报酬率后年化而得
8. **添加时间** - 记录添加的时间戳

### 自动计算功能
- **输入金额和期数 + 每期利息** → 自动计算总利息、利息率、年化利率
- **输入金额和期数 + 总利息** → 自动计算每期利息、利息率、年化利率

### 数据管理
- **保存为CSV** - 将当前表格数据导出为CSV文件
- **加载CSV** - 从CSV文件导入数据到表格

### 排序功能
支持对所有列进行排序：
- 点击列标题进行升序/降序排序
- 支持数值列和文本列的智能排序

## 计算方法说明

### 总利息计算
总利息 = 每期利息 × 期数

### 利息率计算
利息率 = (总利息 ÷ 本金) × 100%

### 近似折算年化利率（单利）计算
近似折算年化利率通过计算内含报酬率(IRR)并年化而得，具体公式如下：

#### 内含报酬率(IRR)定义
内含报酬率IRR是指使未来现金流入量现值等于未来现金流出量现值的折现率。对于分期贷款场景，计算公式为：

$$本金 = \sum_{i=1}^{n} \frac{第i期支付金额}{(1+IRR)^i}$$

其中：
- $n$ 为期数
- $i$ 为期数索引（从1到n）

#### 计算步骤
1. **确定每期支付金额**：
   - 每期支付金额 = 本金/期数 + 每期利息
   
2. **计算月IRR**：
   - 本程序使用牛顿迭代法求解月IRR值
   - 牛顿迭代法通过不断逼近使净现值(NPV)等于0的折现率
   - **迭代公式**：$$IRR_{new} = IRR_{old} - \frac{NPV(IRR_{old})}{NPV'(IRR_{old})}$$
   
   - **净现值(NPV)计算**：$$NPV(IRR) = -本金 + \sum_{i=1}^{n} \frac{每期支付金额}{(1+IRR)^i}$$
   
   - **净现值导数(NPV')计算**：$$NPV'(IRR) = -\sum_{i=1}^{n} \frac{i \times 每期支付金额}{(1+IRR)^{i+1}}$$
   - 当两次迭代结果的差值小于0.000001时停止迭代
   
3. **年化利率转换**：
   - 近似折算年化利率(单利) = 月IRR × 12 × 100%

### 计算准确性说明
- 计算结果保留两位小数
- 牛顿迭代法初始值设为0.01（1%）
- 最大迭代次数为100次，确保计算效率和稳定性


## 技术特性
- 使用 Python + PyQt6 开发
- 支持UTF-8编码的CSV文件
- 防止递归计算的保护机制
- 自动为新记录添加时间戳
- 智能CSV解析，支持包含逗号的字段



## 编译和运行

### 环境要求
- Python 3.8 或更高版本
- MySQL 8.0.36 (可选，用于数据存储)

### 安装依赖
```bash
pip install -r requirements.txt
```

### 运行应用程序
```bash
# 方法1：直接运行主程序
python loan_calculator.py

# 方法2：使用启动脚本
python run.py
```

### 创建可执行文件 (可选)
```bash
# 安装PyInstaller
pip install pyinstaller

# 创建Windows可执行文件
pyinstaller --onefile --windowed --name "贷款计算器" loan_calculator.py

# 生成的可执行文件在 dist/ 目录下
```

## 注意事项
- 金额和期数为必填字段
- 金额和期数必须大于0
- 每期利息或总利息至少填写一个才能触发自动计算
- CSV文件使用UTF-8编码，支持中文显示
- 程序支持数据排序，点击列标题即可排序
- 支持保存和加载CSV格式的数据文件

## 文件说明
- `loan_calculator.py` - 主程序文件
- `run.py` - 启动脚本
- `requirements.txt` - 依赖列表
- `示例数据.csv` - 示例数据文件
- `启动程序.bat` - Windows一键启动脚本